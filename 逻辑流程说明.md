# 代码逻辑流程说明

## 整体流程

### 1. 首页（app/page.tsx）
- **显示内容**：粒子背景 + "开启她的多重宇宙"按钮
- **位置**：`/` 路由
- **关键代码**：
  - `canvasRef`：创建Three.js粒子效果背景
  - `handleStart()`：点击按钮后设置 `showForm = true` 显示对话框

### 2. 对话框（app/page.tsx）
- **触发条件**：点击"开启她的多重宇宙"按钮后显示
- **显示内容**：Windows 98风格的对话框，包含表单：
  - 昵称（nickname）
  - 年龄（age）
  - 城市（city）
  - MBTI
  - "确定"按钮
- **关键代码**：
  - `handleSubmit()`：表单提交处理
    - 保存用户信息到 `localStorage`（key: `flywheel_user`）
    - 调用 `router.push('/box')` 跳转到box页面

### 3. Box页面（app/box/page.tsx）
- **路由**：`/box`
- **显示内容**：3D立方体场景（Box3DScene组件）
- **关键代码**：
  - 检查登录状态：如果没有 `flywheel_user`，跳转回首页
  - 显示所有立方体，等待用户点击

### 4. 3D场景（public/app.js）
- **初始化**：`init()` 函数创建Three.js场景
- **创建立方体**：`createCubes()` 创建3x3x3的立方体网格
- **B2-2盒子**：
  - 位置：底部中心（y = -8）
  - 材质：带纹理（B2-2-box.png）
  - 颜色：青色/绿色（用户称为"绿色盒子"）

### 5. 手动点击B2-2盒子（public/app.js）
- **方式**：用户点击B2-2盒子（绿色/青色盒子）
- **触发**：`onMouseClick()` 事件处理函数

### 7. 打开盒子效果（public/app.js）
- **函数**：`openBox(cube)`
- **效果**：
  - 隐藏所有其他立方体（只保留B2-2）
  - 创建6张照片（从B2-2-1.JPG到B2-2-6.jpg）
  - 创建800个粒子（金色、红色、绿色、黄色等）
  - 照片和粒子从B2-2盒子位置飞出

### 6. 点击B2-2盒子（public/app.js）
- **事件处理**：`onMouseClick(event)`
- **逻辑**：
  - 使用射线投射（Raycaster）检测点击位置
  - 如果点击到B2-2盒子且未打开（`!isBoxOpened`），调用 `openBox(b2_2Cube)`
  - 调用后设置 `isBoxOpened = true`，防止重复打开
- **用户交互**：用户需要手动点击B2-2盒子（绿色/青色盒子）来触发打开效果

## 文件结构

```
app/
├── page.tsx              # 首页：粒子背景 + 按钮 + 对话框
└── box/
    ├── page.tsx          # Box页面：3D场景容器
    └── Box3DScene.tsx    # 3D场景组件（加载app.js）

public/
└── app.js                # 3D场景逻辑：创建立方体、打开盒子、照片粒子效果
```

## 数据流

1. **用户信息存储**：`localStorage.setItem('flywheel_user', JSON.stringify(userInfo))`
2. **页面跳转**：Next.js Router (`router.push('/box')`)
3. **3D场景加载**：Box3DScene组件动态加载 `/app.js` 脚本
4. **用户点击B2-2盒子**：通过鼠标点击事件触发 `openBox()` 函数

## 关键函数

- `handleStart()`：显示对话框
- `handleSubmit()`：保存用户信息并跳转
- `init()`：初始化3D场景
- `createCubes()`：创建立方体网格
- `openBox()`：打开盒子并创建照片/粒子
- `onMouseClick()`：鼠标点击事件处理（检测点击B2-2盒子）

